@startuml
!theme plain

entity users {
  +user_id : serial
  firstname : text
  lastname : text
  phone_number : text
  email : text <<unique, not null>>
  password : text
  role_id : int
}

entity roles {
  +role_id : serial
  role : text <<unique, not null>>
}

entity orders {
  +order_id : serial
  user_id : int <<not null>>
  staff_id : int
  total_price : numeric
}

entity order_status_history {
  *order_id : int
  status : text
  update_date : timestamp <<not null, default: now()>>
  -- PK: (order_id, update_date)
}

entity order_items {
  +order_item_id : serial
  order_id : int <<not null>>
  item_type : varchar(20) <<CHECK ('carport', 'material')>>
  quantity : int <<not null>>
}

entity order_item_carport {
  *order_item_id : int
  carport_id : int <<not null>>
}

entity order_item_material {
  *order_item_id : int
  material_id : int <<not null>>
}

entity carports {
  +carport_id : serial
  width : numeric <<not null>>
  length : numeric <<not null>>
  height : numeric <<not null>>
  roof_type : text <<not null>>
  roof_angle : numeric <<not null>>
  post_material_id : int
  beam_material_id : int
  rafter_material_id : int
  fascia_material_id : int
  total_price : numeric
}

entity materials {
  +material_id : serial
  name : text
  description : text
  unit : text
  width : numeric
  height : numeric
  material_type : text <<not null>>
  buckling_capacity : numeric
  post_gap : numeric
  length_overlap : numeric
  side_overlap : numeric
  gap_rafters : numeric
  is_active : boolean <<not null>>
}

entity predefined_lengths {
  +predefined_length_id : serial
  length : int <<not null>>
}

entity material_lengths {
  *material_id : int
  *predefined_length_id : int
}

entity price_history {
  +price_history_id : serial
  material_id : int
  cost_price : numeric
  sales_price : numeric
  valid_from : date
  valid_to : date
}

' Relationships
users ||--o{ orders : user_id
users ||--o{ orders : staff_id
roles ||--o{ users : role_id
orders ||--o{ order_status_history : order_id
orders ||--o{ order_items : order_id
order_items ||--|| order_item_carport : order_item_id
order_items ||--|| order_item_material : order_item_id
order_item_carport }o--|| carports : carport_id
order_item_material }o--|| materials : material_id
carports }o--|| materials : post_material etc.
materials ||--o{ material_lengths : material_id
predefined_lengths ||--o{ material_lengths : predefined_length_id
materials ||--o{ price_history : material_id
@enduml
